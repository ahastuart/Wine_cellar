# Iot_Cloud_Platform Final Project


# ìŠ¤ë§ˆíŠ¸ ì™€ì¸ ëƒ‰ì¥ê³  ë§¤ë‹ˆì € (Wine_cellar) ğŸ·
-----
###### ë³¸ í”„ë¡œì íŠ¸ëŠ” ì™€ì¸ ì• í˜¸ê°€ë“¤ì„ ìœ„í•œ í¸ë¦¬í•œ ì™€ì¸ ì €ì¥ ë° ì¬ê³  ê´€ë¦¬ ì†”ë£¨ì…˜ì„ ì œê³µí•˜ë©´ì„œ, ì‚¬ìš©ìê°€ ëƒ‰ì¥ê³ ì˜ ìƒíƒœë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ëª¨ë‹ˆí„°ë§í•˜ê³  ì™€ì¸ì˜ ë³´ê´€ ì˜¨ë„ë¥¼ ìµœì í™”í•˜ì—¬ ì™€ì¸ì˜ ë§›ê³¼ í–¥ì„ ìµœëŒ€í™”í•˜ë ¤ëŠ” ëª©ì ì´ ìˆë‹¤.
-----


### 1. ì˜¨ìŠµë„ ì„¼ì„œë¥¼ í™œìš©í•œ ì™€ì¸ ìƒíƒœ ëª¨ë‹ˆí„°ë§ ğŸ“²
ì™€ì¸ ëƒ‰ì¥ê³ ëŠ” 3ì¸µìœ¼ë¡œ ì´ë£¨ì–´ì ¸ ìˆê³ , ê° ì¸µ ë§ˆë‹¤ ì˜¨ìŠµë„ ì„¼ì„œê°€ ë¶€ì°©ì´ ë˜ì–´ ìˆì–´ ì™€ì¸ ë³´ê´€ ìƒíƒœë¥¼ ì•±ìœ¼ë¡œ ëª¨ë‹ˆí„°ë§ í•  ìˆ˜ ìˆë‹¤.
### 2. ì´ˆìŒíŒŒ ì„¼ì„œë¥¼ í™œìš©í•œ ì™€ì¸ ì¬ê³  ëª¨ë‹ˆí„°ë§ ğŸ“²
ê° ì¸µì˜ ì˜†ë©´ ìª½ì— ì´ˆìŒíŒŒ ì„¼ì„œë¥¼ ë¶€ì°©í•˜ì—¬ ì™€ì¸ ì¬ê³  ìƒíƒœë¥¼ ì•±ìœ¼ë¡œ ëª¨ë‹ˆí„°ë§ í•  ìˆ˜ ìˆë‹¤. (ì›ë˜ ê°€ì •ì€ ~~ë¬´ê²Œ ì„¼ì„œ~~)
### 3. ëƒ‰ì¥ê³  ì˜¨ìŠµë„ ì¡°ì ˆ ì›ê²© ì œì–´ â†•
ì‚¬ìš©ìê°€ ì•±ìœ¼ë¡œ ì˜¨ìŠµë„ ìƒíƒœë¥¼ ë³´ê³  ì›í•˜ëŠ” ì˜¨ë„ë¥¼ ë†’ì´ê±°ë‚˜ ë‚®ê²Œ í•  ìˆ˜ ìˆë„ë¡, ì¿¨ë§íŒ¬ê³¼ íˆí„° ê°€ë™ ON,OFF
### 4. ì•± ì•Œë¦¼ ì„œë¹„ìŠ¤ ğŸ””
ì˜¨ìŠµë„ì˜ ì´ìƒ ë° ì¬ê³  ë¶€ì¡± ì‹œ, ê²½ê³  ë©”ì‹œì§€ ì•Œë¦¼ ì„œë¹„ìŠ¤

![initial](https://github.com/ahastuart/Wine_cellar/assets/117140125/f0d691cb-4dd0-4182-90a2-716d09e0bbef)


# ì‹¤í–‰ ê²°ê³¼ ë° ì„¤ëª…

<img src="https://github.com/ahastuart/Wine_cellar/assets/117140125/b9d059b3-a346-4465-80d1-ebaea40c69ae" width="30%" height="30%"/>
<br>ì•± ì´ˆê¸°í™”ë©´

<br>
<img src="https://github.com/ahastuart/Wine_cellar/assets/117140125/cc1f4c6a-6898-421f-9732-6cbc332a6934" width="30%" height="30%"/>
<br> ì•± ëª©ë¡ì¡°íšŒ (ì‚¬ë¬¼: MyMy)

<br>
<img src="https://github.com/ahastuart/Wine_cellar/assets/117140125/3af1d2cf-e3d7-4b8f-b858-25fe04a358ff" width="30%" height="30%"/>
<br> ì•± ìƒíƒœì¡°íšŒ (1,3ì¸µì˜ ì˜¨ìŠµë„ + ì¬ê³  / ëƒ‰ê°íŒ¬ê³¼ íˆí„°ì˜ ìƒíƒœ)

<br>
<img src="https://github.com/ahastuart/Wine_cellar/assets/117140125/f7021b36-fc42-49f0-9578-ac79a03db20e" width="30%" height="30%"/>
<br> ì•± ìƒíƒœë³€ê²½ (ëƒ‰ê°íŒ¬ ìƒíƒœê°€ ONìœ¼ë¡œ ë°”ë€œ)

<br>
<img src="https://github.com/ahastuart/Wine_cellar/assets/117140125/7edc49d5-af4d-49fd-bcb3-975799e4dd16" width="30%" height="30%"/>
<br> ì•± ë¡œê·¸ì¡°íšŒ


# 1. ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
- WiFiNINA (or WiFi101 for the MKR1000)
- ArduinoBearSSL
- ArduinoECCX08
- ArduinoMqttClient
- Arduino Cloud Provider Examples
- DHT sensor library



# 2. AWS IoT ì •ì±… ìƒì„±
ë””ë°”ì´ìŠ¤ê°€ MQTT ì£¼ì œ êµ¬ë…, ê²Œì‹œ ë“±ì˜ AWS IoT ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì„ ë¶€ì—¬í•˜ëŠ”ë° ì‚¬ìš©í•œë‹¤. <br>
ê·¸ë˜ì„œ ì´ë¥¼ ìƒì„±í•˜ì—¬ ë””ë°”ì´ìŠ¤ ì¸ì¦ì„œì— ì—°ê²°í•˜ì—¬ AWS IoT ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆê²Œ ëœë‹¤. <br>
1. IoT Coreì—ì„œ ë³´ì•ˆ - ì •ì±… - [ìƒì„±] ì„ íƒ *(ì •ì±…ì´ë¦„: AllowWine)* <br>
2. ì‘ì—… í•„ë“œì— iot:* ì…ë ¥ -> ë¦¬ì†ŒìŠ¤ ARN í•„ë“œì— * -> [í—ˆìš©] -> ìƒì„±



# 3. X.509 ì¸ì¦ì„œ ì‚¬ìš©í•˜ì—¬ ë””ë°”ì´ìŠ¤ ì¸ì¦
AWS IoT CoreëŠ” X.509 ì¸ì¦ì„œë¥¼ ì‚¬ìš©í•˜ì—¬ ë””ë°”ì´ìŠ¤ë¥¼ ì¸ì¦í•œë‹¤. <br>
1. Arduino IDEì˜ íŒŒì¼ - ì˜ˆì œ - ArduinoECCX08 - Tools - ECCX08CSR ì„ íƒí•˜ì—¬ ì—…ë¡œë“œ <br>
2. Common Nameì—ë§Œ ì•ìœ¼ë¡œ ë§Œë“¤ ì‚¬ë¬¼ ì´ë¦„*(MyMy)* ì ì€ í›„, csr ìƒì„± -> ë”°ë¡œ csr.txtíŒŒì¼ë¡œ ì €ì¥í•˜ê¸°



# 4. ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— ë””ë°”ì´ìŠ¤ ë“±ë¡
1. AWS IoT Coreì—ì„œ ê´€ë¦¬ - ì‚¬ë¬¼ - ì‚¬ë¬¼ìƒì„± - ë‹¨ì¼ ì‚¬ë¬¼ìƒì„± *(ì‚¬ë¬¼ì´ë¦„: MyMY)* - ì´ë¦„ ì—†ëŠ” ì„€ë„ìš° - csr ì—…ë¡œë“œ - ì •ì±… ì—°ê²° *(AllowWine)* -  ì‚¬ë¬¼ ìƒì„±



# 5. ë””ë°”ì´ìŠ¤ êµ¬ì„± ë° í…ŒìŠ¤íŠ¸
1. AWS IoT Coreì—ì„œ ë³´ì•ˆ - ì¸ì¦ì„œ - *[ë“œë¡­ë‹¤ìš´]* í™œì„±í™” - ë‹¤ìš´ë¡œë“œ <br>
2. Arduino_code í´ë”ì— ìˆëŠ” íŒŒì¼ ì—´ê¸° <br>
3. arduino_secret.h íƒ­ì—ì„œ ê°œì¸ WiFi SSIDì™€ Password ì„¤ì • -> ì—”ë“œí¬ì¸íŠ¸ ì„¤ì • *(AWS IoT Core - ì„¤ì •ì—ì„œ í™•ì¸ ê°€ëŠ¥)* -> ì¸ì¦ì„œ íŒŒì¼ ë³µì‚¬ ë¶™ì—¬ë„£ê¸° *(ì•ì„œ ë‹¤ìš´ë¡œë“œ íŒŒì¼ ì—´ê¸°)* <br>



# 6. AWS DynamoDB í…Œì´ë¸” ìƒì„± ë° Lambda í•¨ìˆ˜ ì •ì˜
1. DynamoDBì—ì„œ í…Œì´ë¸” - í…Œì´ë¸” ìƒì„± - í…Œì´ë¸” ì´ë¦„ *(WineTable)* - íŒŒí‹°ì…˜ í‚¤ *(deviceId: ë¬¸ìì—´) - ì •ë ¬ í‚¤ (time: ë²ˆí˜¸) <br>
2. IntelliJ IDEAì—ì„œ í”„ë¡œì íŠ¸ ìƒì„± ( í”„ë¡œì íŠ¸ ì´ë¦„: *LoggingWineLambda* / Runtime: *java11* / SDK: *11ë²„ì „* ) <br>
3. build.gradle íŒŒì¼ì—ì„œ ì˜ì¡´ì„± ì¶”ê°€ í›„, ë³€ê²½ì‚¬í•­ ë°˜ì˜ -> App íŒŒì¼ ìˆ˜ì • -> AppTest íŒŒì¼ ì£¼ì„ì²˜ë¦¬ -> ì»´íŒŒì¼ì¼
-----
src/main/java/helloworld/App.java íŒŒì¼ Code <br>
```
package helloworld;

import java.text.SimpleDateFormat;
import java.util.TimeZone;

import com.amazonaws.services.dynamodbv2.AmazonDynamoDB;
import com.amazonaws.services.dynamodbv2.AmazonDynamoDBClientBuilder;
import com.amazonaws.services.dynamodbv2.document.DynamoDB;
import com.amazonaws.services.dynamodbv2.document.Item;
import com.amazonaws.services.dynamodbv2.document.spec.PutItemSpec;
import com.amazonaws.services.dynamodbv2.model.ConditionalCheckFailedException;
import com.amazonaws.services.lambda.runtime.Context;
import com.amazonaws.services.lambda.runtime.RequestHandler;

public class App implements RequestHandler<Document, String> {
    private DynamoDB dynamoDb;
    private String DYNAMODB_TABLE_NAME = "WineTable";

    @Override
    public String handleRequest(Document input, Context context) {
        this.initDynamoDbClient();
        context.getLogger().log("Input: " + input);

        //return null;
        return persistData(input);
    }

    private String persistData(Document document) throws ConditionalCheckFailedException {

        // Epoch Conversion Code: https://www.epochconverter.com/
        SimpleDateFormat sdf = new SimpleDateFormat ( "yyyy-MM-dd HH:mm:ss");
        sdf.setTimeZone(TimeZone.getTimeZone("Asia/Seoul"));
        String timeString = sdf.format(new java.util.Date (document.timestamp*1000));


        if (document.current.state.reported.inventory.equals(
                document.previous.state.reported.inventory) &&
                document.current.state.reported.inventory3.equals(
                        document.previous.state.reported.inventory3) &&
                document.current.state.reported.LED.equals(
                        document.previous.state.reported.LED) &&
                document.current.state.reported.LED3.equals(
                        document.previous.state.reported.LED3) &&
                document.current.state.reported.temperature.equals(
                        document.previous.state.reported.temperature) &&
                document.current.state.reported.temperature3.equals(
                        document.previous.state.reported.temperature3) &&
                document.current.state.reported.humidity3.equals(
                        document.previous.state.reported.humidity3) &&
                document.current.state.reported.humidity.equals(
                        document.previous.state.reported.humidity)) {
            return null;
        }

        return this.dynamoDb.getTable(DYNAMODB_TABLE_NAME)
                .putItem(new PutItemSpec().withItem(new Item().withPrimaryKey("deviceId", document.device)
                        .withLong("time", document.timestamp)
                        .withString("temperature", document.current.state.reported.temperature)
                        .withString("humidity", document.current.state.reported.humidity)
                        .withString("temperature3", document.current.state.reported.temperature3)
                        .withString("humidity3", document.current.state.reported.humidity3)
                        .withString("inventory", document.current.state.reported.inventory)
                        .withString("inventory3", document.current.state.reported.inventory3)
                        .withString("LED", document.current.state.reported.LED)
                        .withString("LED3", document.current.state.reported.LED3)
                        .withString("timestamp",timeString)))
                .toString();
    }

    private void initDynamoDbClient() {
        AmazonDynamoDB client = AmazonDynamoDBClientBuilder.standard().withRegion("ap-northeast-2").build();

        this.dynamoDb = new DynamoDB(client);
    }

}

class Document {
    public Thing previous;
    public Thing current;
    public long timestamp;
    public String device;       // AWS IoTì— ë“±ë¡ëœ ì‚¬ë¬¼ ì´ë¦„
}

class Thing {
    public State state = new State();
    public long timestamp;
    public String clientToken;

    public class State {
        public Tag reported = new Tag();
        public Tag desired = new Tag();

        public class Tag {
            public String temperature;
            public String humidity;
            public String temperature3;
            public String humidity3;
            public String inventory;
            public String inventory3;
            public String LED;
            public String LED3;

        }
    }
}
```
-json ì˜ˆì‹œ <br>
```
{
  "previous": {
    "state": {
      "reported": {
        "temperature": "2",
        "humidity": "3",
        "temperature3": "3",
        "humidity3": "8",
        "inventory" : "1",
        "inventory3" : "1",
        "LED": "OFF",
        "LED3": "ON"
      }
    }
  },
  "current": {
    "state": {
      "reported": {
        "temperature": "9",
        "humidity": "48",
        "temperature3": "26",
        "humidity3": "74",
        "inventory" : "0",
        "inventory3" : "0",
        "LED": "OFF",
        "LED3": "OFF"
      }
    }
  },
  "timestamp": 1575178117,
  "device":"MyMy"
}
```
-----
4. ëŒë‹¤í•¨ìˆ˜ *(LoggingWineLambda)* í•¨ìˆ˜ ìƒì„± í›„, ë°°í¬ -> AmazonDynamoDBFullAccess ì •ì±… ê¶Œí•œ ì¶”ê°€  <br>
5. AWS IoT Coreì—ì„œ ë©”ì‹œì§€ ë¼ìš°íŒ… - ê·œì¹™ - ê·œì¹™ìƒì„± - SQLë¬¸ ì…ë ¥ - lambdaí•¨ìˆ˜ *(LoggingWineLambda)* ì„ íƒ í›„ ìƒì„±
   SELECT * FROM '$aws/things/MyMy/shadow/update/accepted'  <br>


# 7. API Gatewayë¥¼ í†µí•œ REST API êµ¬ì¶•í•˜ê¸°
## 7-1. ë””ë°”ì´ìŠ¤ ëª©ë¡ ì¡°íšŒ
- Lambda Name: ListingWineLambda  <br>
- version: java 11  <br>
-----
App.java Code
```
package helloworld;
import java.util.List;
import com.amazonaws.services.iot.AWSIot;
import com.amazonaws.services.iot.AWSIotClientBuilder;
import com.amazonaws.services.iot.model.ListThingsRequest;
import com.amazonaws.services.iot.model.ListThingsResult;
import com.amazonaws.services.iot.model.ThingAttribute;
import com.amazonaws.services.lambda.runtime.Context;
import com.amazonaws.services.lambda.runtime.RequestHandler;

public class App implements RequestHandler<Object, String> {

    @Override
    public String handleRequest(Object input, Context context) {

        // AWSIot ê°ì²´ë¥¼ ì–»ëŠ”ë‹¤.
        AWSIot iot = AWSIotClientBuilder.standard().build();

        // ListThingsRequest ê°ì²´ ì„¤ì •.
        ListThingsRequest listThingsRequest = new ListThingsRequest();

        // listThings ë©”ì†Œë“œ í˜¸ì¶œí•˜ì—¬ ê²°ê³¼ ì–»ìŒ.
        ListThingsResult result = iot.listThings(listThingsRequest);

        return getResultStr(result);
    }


    /**
     * ListThingsResult ê°ì²´ì¸ resultë¡œ ë¶€í„° ThingNameê³¼ ThingArnì„ ì–»ì–´ì„œ Jsonë¬¸ì í˜•ì‹ì˜
     * ì‘ë‹µëª¨ë¸ì„ ë§Œë“¤ì–´ ë°˜í™˜í•œë‹¤.
     * {
     * 	"things": [
     *	     {
     *			"thingName": "string",
     *	      	"thingArn": "string"
     *	     },
     *		 ...
     *	   ]
     * }
     */
    private String getResultStr(ListThingsResult result) {
        List<ThingAttribute> things = result.getThings();

        String resultString = "{ \"things\": [";
        for (int i =0; i<things.size(); i++) {
            if (i!=0)
                resultString +=",";
            resultString += String.format("{\"thingName\":\"%s\", \"thingArn\":\"%s\"}",
                    things.get(i).getThingName(),
                    things.get(i).getThingArn());

        }
        resultString += "]}";
        return resultString;
    }

}
```
-----
1. Lambda í•¨ìˆ˜ ìƒì„± í›„, AWSIoTFullAccess ê¶Œí•œ ì¶”ê°€ -> í…ŒìŠ¤íŠ¸  <br>
2. API Gatewayì—ì„œ API ìƒì„± - REST API ìƒì„± - API ì´ë¦„ *(wine-api)* - API ìƒì„±  <br>
3. ë¦¬ì†ŒìŠ¤ ì•„ë˜ì— /ë¥¼ ì„ íƒ -> ë¦¬ì†ŒìŠ¤ ìƒì„± -> ë¦¬ì†ŒìŠ¤ ì´ë¦„ *(devices)*  <br>
4. ë©”ì„œë“œ ì„¹ì…˜ - ë©”ì†Œë“œ ìƒì„± - Get - í†µí•©ìœ í˜•ì—ì„œ Lambdaí•¨ìˆ˜(ListingWineLambda) ì„ íƒ - ë©”ì„œë“œ ìƒì„± í›„ í…ŒìŠ¤íŠ¸  <br>
5. ë¦¬ì†ŒìŠ¤ì—ì„œ /devices ì„ íƒ -> CORS í™œì„±í™” -> ëª¨ë“  ì²´í¬ë°•ìŠ¤ ì„ íƒ -> ì €ì¥  <br>
6. API ë°°í¬ - ìƒˆ ìŠ¤í…Œì´ì§€ - prod - ë°°í¬  <br>


## 7-2. ë””ë°”ì´ìŠ¤ ìƒíƒœ ì¡°íšŒ
- Lambda Name: GetWineLambda  <br>
- version: java 11  <br>
-----
App.java Code
```
package helloworld;

import com.amazonaws.services.iotdata.AWSIotData;
import com.amazonaws.services.iotdata.AWSIotDataClientBuilder;
import com.amazonaws.services.iotdata.model.GetThingShadowRequest;
import com.amazonaws.services.lambda.runtime.Context;
import com.amazonaws.services.lambda.runtime.RequestHandler;

/**
 * Handler for requests to Lambda function.
 */
public class App implements RequestHandler<Event, String> {

    public String handleRequest(final Event event, final Context context) {

        AWSIotData iotData = AWSIotDataClientBuilder.standard().build();

        GetThingShadowRequest getThingShadowRequest =
                new GetThingShadowRequest()
                        .withThingName(event.device);

        String output = new String(
                iotData.getThingShadow(getThingShadowRequest).getPayload().array());

        return output;
    }
}

class Event {
    public String device;
}
```
-json ì˜ˆì‹œ <br>
```
{
  "device" : "MyMy"
}
```
-----
1. Lambda í•¨ìˆ˜ ìƒì„± í›„, AWSIoTFullAccess ê¶Œí•œ ì¶”ê°€ -> í…ŒìŠ¤íŠ¸  <br>
2. API Gatewayì—ì„œ ì´ì „ì— ìƒì„±í•œ wine-apië¥¼ ì„ íƒ -> /devices ì„ íƒ -> ë¦¬ì†ŒìŠ¤ ìƒì„± -> ë¦¬ì†ŒìŠ¤ ì´ë¦„ : *{devices}*  <br>
3. ë©”ì„œë“œ ì„¹ì…˜ - ë©”ì†Œë“œ ìƒì„± - Get - í†µí•©ìœ í˜•ì—ì„œ Lambdaí•¨ìˆ˜(GetWineLambda) ì„ íƒ - Lambda í”„ë¡ì‹œ í†µí•©ì€ ì„ íƒì•ˆëœ ìƒíƒœ ìœ ì§€ - ë©”ì„œë“œ ìƒì„± í›„ í…ŒìŠ¤íŠ¸  <br>
4. í†µí•© ìš”ì²­ - í…œí”Œë¦¿ ìƒì„± - ì½˜í…ì¸  ìœ í˜•: application/json - ë©”ì„œë“œ ìš”ì²­ ë§¤ìŠ¤ìŠ¤ë£¨ - í…œí”Œë¦¿ ë³¸ë¬¸ì— ë‹¤ìŒê³¼ ê°™ì´ ì…ë ¥ í›„ ìƒì„±  <br>
```
 {
     "device": "$input.params('device')"
 }
```
6. ë¦¬ì†ŒìŠ¤ì—ì„œ /devices/{devices} ì„ íƒ -> CORS í™œì„±í™” -> ëª¨ë“  ì²´í¬ë°•ìŠ¤ ì„ íƒ -> ì €ì¥  <br>
7. API ë°°í¬ - ìƒˆ ìŠ¤í…Œì´ì§€ - prod - ë°°í¬  <br>


## 7-3. ë””ë°”ì´ìŠ¤ ìƒíƒœ ë³€ê²½
- Lambda Name: UpdateWineLambda  <br>
- version: java 11  <br>
-----
App.java Code
```
package helloworld;

import java.nio.ByteBuffer;
import java.util.ArrayList;
import com.amazonaws.services.lambda.runtime.Context;
import com.amazonaws.services.lambda.runtime.RequestHandler;
import com.amazonaws.services.iotdata.AWSIotData;
import com.amazonaws.services.iotdata.AWSIotDataClientBuilder;
import com.amazonaws.services.iotdata.model.UpdateThingShadowRequest;
import com.amazonaws.services.iotdata.model.UpdateThingShadowResult;
import com.fasterxml.jackson.annotation.JsonCreator;

/**
 * Handler for requests to Lambda function.
 */
public class App implements RequestHandler<Event, String> {

    public String handleRequest(final Event event, final Context context) {
        AWSIotData iotData = AWSIotDataClientBuilder.standard().build();

        String payload = getPayload(event.tags);

        UpdateThingShadowRequest updateThingShadowRequest  =
                new UpdateThingShadowRequest()
                        .withThingName(event.device)
                        .withPayload(ByteBuffer.wrap(payload.getBytes()));

        UpdateThingShadowResult result = iotData.updateThingShadow(updateThingShadowRequest);
        byte[] bytes = new byte[result.getPayload().remaining()];
        result.getPayload().get(bytes);
        String output = new String(bytes);

        return output;
    }

    private String getPayload(ArrayList<Tag> tags) {
        String tagstr = "";
        for (int i=0; i < tags.size(); i++) {
            if (i !=  0) tagstr += ", ";
            tagstr += String.format("\"%s\" : \"%s\"", tags.get(i).tagName, tags.get(i).tagValue);
        }
        return String.format("{ \"state\": { \"desired\": { %s } } }", tagstr);
    }
}

class Event {
    public String device;
    public ArrayList<Tag> tags;

    public Event() {
        tags = new ArrayList<Tag>();
    }
}

class Tag {
    public String tagName;
    public String tagValue;

    @JsonCreator
    public Tag() {
    }

    public Tag(String n, String v) {
        tagName = n;
        tagValue = v;
    }
}

```
-json ì˜ˆì‹œ <br>
```
{
  "device": "MyMy",
  "tags" : [
    {
      "tagName": "temperature",
      "tagValue": "10"
    },
    {
      "tagName": "humidity",
      "tagValue": "33"
    },
    {
      "tagName": "temperature3",
      "tagValue": "25"
    },
    {
      "tagName": "humidity3",
      "tagValue": "72"
    },
    {
      "tagName": "inventory",
      "tagValue": "100"
    },
    {
      "tagName": "inventory3",
      "tagValue": "0"
    },
    {
      "tagName": "LED",
      "tagValue": "OFF"
    },
    {
      "tagName": "LED3",
      "tagValue": "OFF"
    }
  ]
}
```
-----
1. Lambda í•¨ìˆ˜ ìƒì„± í›„, AWSIoTFullAccess ê¶Œí•œ ì¶”ê°€ -> í…ŒìŠ¤íŠ¸  <br>
2. API Gatewayì—ì„œ ì´ì „ì— ìƒì„±í•œ wine-apië¥¼ ì„ íƒ -> /{device} ì„ íƒ  ë©”ì„œë“œ ì„¹ì…˜ - ë©”ì†Œë“œ ìƒì„± - PUT - í†µí•©ìœ í˜•ì—ì„œ Lambdaí•¨ìˆ˜(GetWineLambda) ì„ íƒ- ë©”ì„œë“œ ìƒì„±  <br>
3. ëª¨ë¸ - ëª¨ë¸ ìƒì„± - ëª¨ë¸ ì´ë¦„: UpdateWineInput - ì½˜í…ì¸  ìœ í˜•: application/json - ìŠ¤í‚¤ë§ˆ ì •ì˜
```
 {
      "$schema": "http://json-schema.org/draft-04/schema#",
      "title": "UpdateWineInput",
  	 "type" : "object",
      "properties" : {
      	"tags" : {
      		"type": "array",
             "items": {
                       "type": "object",
                       "properties" : {
                         	"tagName" : { "type" : "string"},
                         	"tagValue" : { "type" : "string"}
             		}
             }
         }
     }
 }
```
4. /{devices} PUT ë©”ì„œë“œ ì„ íƒ - í†µí•© ìš”ì²­ - í…œí”Œë¦¿ ìƒì„± - ì½˜í…ì¸  ìœ í˜•: application/json - í…œí”Œë¦¿ ìƒì„±ì—ì„œ UpdateWineInput ì„ íƒíƒ - í…œí”Œë¦¿ ë³¸ë¬¸ì— ë‹¤ìŒê³¼ ê°™ì´ ì…ë ¥ í›„ ìƒì„±  <br>
```
 #set($inputRoot = $input.path('$'))
 {
     "device": "$input.params('device')",
     "tags" : [
     ##TODO: Update this foreach loop to reference array from input json
         #foreach($elem in $inputRoot.tags)
         {
             "tagName" : "$elem.tagName",
             "tagValue" : "$elem.tagValue"
         } 
         #if($foreach.hasNext),#end
         #end
     ]
 }
```
6. ë¦¬ì†ŒìŠ¤ì—ì„œ /devices/{devices} ì„ íƒ -> CORS í™œì„±í™” -> ëª¨ë“  ì²´í¬ë°•ìŠ¤ ì„ íƒ -> ì €ì¥  <br>
7. API ë°°í¬ - ìƒˆ ìŠ¤í…Œì´ì§€ - prod - ë°°í¬  <br>


## 7-4. ë””ë°”ì´ìŠ¤ ë¡œê·¸ ì¡°íšŒ
- Lambda Name: LogWineLambda  <br>
- version: java 11  <br>
-----
App.java Code
```
package helloworld;

import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.Iterator;
import java.util.TimeZone;


import com.amazonaws.services.lambda.runtime.Context;
import com.amazonaws.services.lambda.runtime.RequestHandler;

import com.amazonaws.services.dynamodbv2.AmazonDynamoDB;
import com.amazonaws.services.dynamodbv2.AmazonDynamoDBClientBuilder;
import com.amazonaws.services.dynamodbv2.document.DynamoDB;
import com.amazonaws.services.dynamodbv2.document.Item;
import com.amazonaws.services.dynamodbv2.document.ItemCollection;
import com.amazonaws.services.dynamodbv2.document.QueryOutcome;
import com.amazonaws.services.dynamodbv2.document.Table;
import com.amazonaws.services.dynamodbv2.document.spec.QuerySpec;
import com.amazonaws.services.dynamodbv2.document.utils.NameMap;
import com.amazonaws.services.dynamodbv2.document.utils.ValueMap;

/**
 * Handler for requests to Lambda function.
 */
public class App implements RequestHandler<Event, String> {
    private DynamoDB dynamoDb;
    private String DYNAMODB_TABLE_NAME = "WineTable";

    public String handleRequest(final Event input, final Context context) {

        this.initDynamoDbClient();
        Table table = dynamoDb.getTable(DYNAMODB_TABLE_NAME);

        long from=0;
        long to=0;
        try {
            SimpleDateFormat sdf = new SimpleDateFormat ( "yyyy-MM-dd HH:mm:ss");
            sdf.setTimeZone(TimeZone.getTimeZone("Asia/Seoul"));

            from = sdf.parse(input.from).getTime() / 1000;
            to = sdf.parse(input.to).getTime() / 1000;
        } catch (ParseException e1) {
            e1.printStackTrace();
        }

        QuerySpec querySpec = new QuerySpec()
                .withKeyConditionExpression("deviceId = :v_id and #t between :from and :to")
                .withNameMap(new NameMap().with("#t", "time"))
                .withValueMap(new ValueMap().withString(":v_id",input.device).withNumber(":from", from).withNumber(":to", to));

        ItemCollection<QueryOutcome> items=null;
        try {
            items = table.query(querySpec);
        }
        catch (Exception e) {
            System.err.println("Unable to scan the table:");
            System.err.println(e.getMessage());
        }
        String output = getResponse(items);

        return output;
    }

    private String getResponse(ItemCollection<QueryOutcome> items) {

        Iterator<Item> iter = items.iterator();
        String response = "{ \"data\": [";
        for (int i =0; iter.hasNext(); i++) {
            if (i!=0)
                response +=",";
            response += iter.next().toJSON();
        }
        response += "]}";
        return response;
    }

    private void initDynamoDbClient() {
        AmazonDynamoDB client = AmazonDynamoDBClientBuilder.standard().build();

        this.dynamoDb = new DynamoDB(client);
    }

}

class Event {
    public String device;
    public String from;
    public String to;
}

```
-json ì˜ˆì‹œ <br>
```
{ "device": "MyMy", "from":"2019-12-01 14:28:10", "to": "2023-12-09 22:13:58"}
```
-----
1. Lambda í•¨ìˆ˜ ìƒì„± í›„, AmazonDynamoDBFullAccess ê¶Œí•œ ì¶”ê°€ -> í…ŒìŠ¤íŠ¸  <br>
2. API Gatewayì—ì„œ ì´ì „ì— ìƒì„±í•œ wine-apië¥¼ ì„ íƒ -> /{device} ì„ íƒ - ë¦¬ì†ŒìŠ¤ ìƒì„± - ë¦¬ì†ŒìŠ¤ ì´ë¦„: log
3. ë©”ì„œë“œ ì„¹ì…˜ - ë©”ì†Œë“œ ìƒì„± - ë©”ì„œë“œ ìœ í˜•: Get - í†µí•© ìœ í˜•ì—ì„œ Lambdaí•¨ìˆ˜ *(LogWineLambda)* ì„ íƒ
4. ë©”ì„œë“œ ì‹¤í–‰ - ë©”ì„œë“œ ìš”ì²­ - ë©”ì„œë“œ ìš”ì²­ ì„¤ì •ì˜ í¸ì§‘ - URL ì¿¼ë¦¬ ë¬¸ìì—´ íŒŒë¼ë¯¸í„° - ì´ë¦„ì— fromê³¼ toì…ë ¥ (í•„ìˆ˜ì˜µì…˜)
5. /log GET ë©”ì„œë“œ ì„ íƒ - í†µí•© ìš”ì²­ - í…œí”Œë¦¿ ìƒì„± - ì½˜í…ì¸  ìœ í˜•: application/json - í…œí”Œë¦¿ ìƒì„±ì—ì„œ UpdateWineInput ì„  - í…œí”Œë¦¿ ë³¸ë¬¸ì— ë‹¤ìŒê³¼ ê°™ì´ ì…ë ¥ í›„ ìƒì„±  <br>
```
 {
   "device": "$input.params('device')",
   "from": "$input.params('from')",
   "to":  "$input.params('to')"
 }
```
6. ë¦¬ì†ŒìŠ¤ì—ì„œ /devices/{devices}/log ì„ íƒ -> CORS í™œì„±í™” -> ëª¨ë“  ì²´í¬ë°•ìŠ¤ ì„ íƒ -> ì €ì¥  <br>
7. API ë°°í¬ - ìƒˆ ìŠ¤í…Œì´ì§€ - prod - ë°°í¬  <br>



